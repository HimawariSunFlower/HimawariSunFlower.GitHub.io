<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>go1.16 docker build遇到的问题 - HimawariSunFlower&#39;s home</title><meta name="Description" content="后端技术博客"><meta property="og:title" content="go1.16 docker build遇到的问题" />
<meta property="og:description" content="在我本机能运行的Dockerfile，在同事机器上build步骤会失败 Dockerfile: FROM golang:1.16 AS builder ARG APP_RELATIVE_PATH COPY . /src WORKDIR /src/app/${APP_RELATIVE_PATH} RUN GOPROXY=https://goproxy.cn make build FROM debian:stable-slim ARG APP_RELATIVE_PATH RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \ ca-certificates \ netbase \ &amp;&amp; rm" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://HimawariSunFlower.github.io/posts/go_sum/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-23T14:11:27+08:00" />
<meta property="article:modified_time" content="2022-09-23T14:29:01+08:00" /><meta property="og:site_name" content="HimawariSunFlower&#39;s home" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="go1.16 docker build遇到的问题"/>
<meta name="twitter:description" content="在我本机能运行的Dockerfile，在同事机器上build步骤会失败 Dockerfile: FROM golang:1.16 AS builder ARG APP_RELATIVE_PATH COPY . /src WORKDIR /src/app/${APP_RELATIVE_PATH} RUN GOPROXY=https://goproxy.cn make build FROM debian:stable-slim ARG APP_RELATIVE_PATH RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \ ca-certificates \ netbase \ &amp;&amp; rm"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://HimawariSunFlower.github.io/posts/go_sum/" /><link rel="prev" href="http://HimawariSunFlower.github.io/posts/doceker_1/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "go1.16 docker build遇到的问题",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/HimawariSunFlower.github.io\/posts\/go_sum\/"
        },"genre": "posts","wordcount":  573 ,
        "url": "http:\/\/HimawariSunFlower.github.io\/posts\/go_sum\/","datePublished": "2022-09-23T14:11:27+08:00","dateModified": "2022-09-23T14:29:01+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "qiyuanh"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="HimawariSunFlower&#39;s home">HimawariSunFlower&#39;s home</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="HimawariSunFlower&#39;s home">HimawariSunFlower&#39;s home</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">go1.16 docker build遇到的问题</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/HimawariSunFlower" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>qiyuanh</a>
</span>&nbsp;<span class="post-category">收录于 <a href="/categories/golang/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>golang</a>&nbsp;<a href="/categories/docker/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>docker</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-09-23">2022-09-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;约 573 字&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;预计阅读 2 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents"></nav></div>
            </div><div class="content" id="content"><p>在我本机能运行的Dockerfile，在同事机器上build步骤会失败<br>
Dockerfile:</p>
<pre tabindex="0"><code>FROM golang:1.16 AS builder

ARG APP_RELATIVE_PATH

COPY . /src
WORKDIR /src/app/${APP_RELATIVE_PATH}

RUN GOPROXY=https://goproxy.cn make build

FROM debian:stable-slim

ARG APP_RELATIVE_PATH

RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \
		ca-certificates  \
        netbase \
        &amp;&amp; rm -rf /var/lib/apt/lists/ \
        &amp;&amp; apt-get autoremove -y &amp;&amp; apt-get autoclean -y

COPY --from=builder /src/app/${APP_RELATIVE_PATH}/bin /app

WORKDIR /app

EXPOSE 8000
EXPOSE 9000
VOLUME /data/conf

CMD [&#34;./server&#34;, &#34;-conf&#34;, &#34;/data/conf&#34;]
</code></pre><p>Makefile:</p>
<pre tabindex="0"><code>.PHONY: build
# build
build:
	mkdir -p bin/ &amp;&amp; go build -ldflags &#34;-X main.Version=$(VERSION)&#34; -o ./bin/ ./...
</code></pre><p>帮他排查问题,报错信息:</p>
<pre tabindex="0"><code>     =&gt; ERROR [builder 4/4] RUN GOPROXY=https://goproxy.cn make build                                                                                                                                                            4.5s
------
 &gt; [builder 4/4] RUN GOPROXY=https://goproxy.cn make build:
#11 0.554 mkdir -p bin/ &amp;&amp; go build -ldflags &#34;-X main.Version=42ad07a&#34; -o ./bin/ ./...
#11 4.415 go: github.com/spf13/cast@v1.5.0 requires
#11 4.415       github.com/frankban/quicktest@v1.14.3: missing go.sum entry; to add it:
#11 4.415       go mod download github.com/frankban/quicktest
#11 4.422 make: *** [../../../app_makefile:72: build] Error 1
------
executor failed running [/bin/sh -c GOPROXY=https://goproxy.cn make   build]: exit code: 2
make: *** [docker] Error 1
</code></pre><p>google一下，用go mod tidy解决<br>
还是报错<br>
看下go env
goproxy，没有中国代理，加上之后<br>
还是报错<br>
陷入僵局了，将我本地的go mod，go sum copy 给他<br>
还是报错<br>
再googel一下，发现一个相关<a href="https://github.com/google/wire/issues/299" target="_blank" rel="noopener noreffer">issue</a>
</p>
<pre tabindex="0"><code>    GOFLAGS=-mod=mod go generate ./...
</code></pre><p>再追踪进去<a href="https://github.com/golang/go/issues/44129" target="_blank" rel="noopener noreffer">issue</a>
</p>
<pre tabindex="0"><code>    go build -mod=mod
</code></pre><p>根据这个指令改动一下build</p>
<pre tabindex="0"><code>    cd ../../.. &amp;&amp; docker build -mod=mod -f deploy/build/Dockerfile  
 --build-arg APP_RELATIVE_PATH=$(APP_RELATIVE_PATH) -t $(DOCKER_IMAGE) .
</code></pre><p>成功了</p>
<p>确实是go1.16版本bug导致的</p>
<p>思考： -mod=mod 为什么能成功？<br>
<a href="https://stackoverflow.com/questions/71121641/what-does-this-command-do-goflags-mod-mod" target="_blank" rel="noopener noreffer">stackoverflow</a>
<br>
-mod=mod go尝试更新拉取gomod，看来只能定义成1.16的go mod tidy指令有bug<br>
<a href="https://go.dev/ref/mod#authenticating" target="_blank" rel="noopener noreffer">官方解释</a>
:</p>
<pre tabindex="0"><code>The go command starts by searching the build list for modules with paths that are prefixes  
of the package path. For example, if the package example.com/a/b is imported, and   
the module example.com/a is in the build list, the go command will check whether  
example.com/a contains the package, in the directory b. At least one file with the .go  
extension must be present in a directory for it to be considered a package. Build   
constraints are not applied for this purpose. If exactly one module in the build list  
provides the package, that module is used. If no modules provide the package or if two or  
more modules provide the package, the go command reports an error. The -mod=mod flag  
instructs the go command to attempt to find new modules providing missing packages and to  
update go.mod and go.sum. The go get and go mod tidy commands do this automatically.
</code></pre></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-09-23</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://HimawariSunFlower.github.io/posts/go_sum/" data-title="go1.16 docker build遇到的问题"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://HimawariSunFlower.github.io/posts/go_sum/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="http://HimawariSunFlower.github.io/posts/go_sum/" data-title="go1.16 docker build遇到的问题" data-web><i class="fab fa-whatsapp fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="http://HimawariSunFlower.github.io/posts/go_sum/" data-title="go1.16 docker build遇到的问题"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://HimawariSunFlower.github.io/posts/go_sum/" data-title="go1.16 docker build遇到的问题"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="http://HimawariSunFlower.github.io/posts/go_sum/" data-title="go1.16 docker build遇到的问题" data-description=""><i class="fab fa-blogger fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="http://HimawariSunFlower.github.io/posts/go_sum/" data-title="go1.16 docker build遇到的问题"><i class="fab fa-evernote fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/doceker_1/" class="prev" rel="prev" title="docker 初体验"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>docker 初体验</a></div>
</div>
<div id="comments"><div id="utterances" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://utteranc.es/">Utterances</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.101.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/HimawariSunFlower" target="_blank">qiyuanh</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/copy-tex.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":50},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"HimawariSunFlower/HimawariSunFlower.github.io"}},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"","algoliaIndex":"","algoliaSearchKey":"","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
